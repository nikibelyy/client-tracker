<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>–í–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ ‚Äî –≤—ã–∑–æ–≤–¥—Ç–ø.—Ä—Ñ</title>
<style>
  body{margin:0;font-family:sans-serif;background:#f7f7f7}
  .wrap{max-width:800px;margin:auto;padding:10px}
  h1{font-size:18px;margin:10px 0}
  .drop{border:2px dashed #ccc;border-radius:8px;padding:20px;text-align:center;background:#fff;margin-bottom:12px;cursor:pointer}
  .controls{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
  .btn{padding:10px 14px;border-radius:6px;border:none;font-weight:600;cursor:pointer}
  .btn.primary{background:#2b6cb0;color:#fff}
  .btn.secondary{background:#e6eefc;color:#2b6cb0}
  .grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}
  .thumb{background:#fff;padding:8px;border-radius:6px;text-align:center}
  .thumb img{max-width:100%;height:auto;border-radius:4px}
  .actions{margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;justify-content:center}
  .actions a,.actions button{font-size:12px;padding:6px 8px}
  .small{font-size:12px;color:#555}
</style>
</head>
<body>
<div class="wrap">
  <h1>–í–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ ‚Äî –≤—ã–∑–æ–≤–¥—Ç–ø.—Ä—Ñ</h1>

  <label class="drop">
    üì∏ –ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ (–∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏ —Å—é–¥–∞)
    <input id="fileInput" type="file" accept="image/*" multiple capture="environment" style="display:none" />
  </label>

  <div class="controls">
    <label>–ù–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å <input id="opacity" type="range" min="0.05" max="0.3" step="0.01" value="0.1"></label>
    <label>–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ <input id="scale" type="range" min="4" max="20" step="1" value="10"></label>
    <button id="clearBtn" class="btn secondary">–û—á–∏—Å—Ç–∏—Ç—å</button>
    <button id="zipBtn" class="btn primary">–°–∫–∞—á–∞—Ç—å –≤—Å—ë (.zip)</button>
  </div>

  <div id="grid" class="grid"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jszip@4.1.0/dist/jszip.min.js"></script>
<script>
const fileInput=document.getElementById('fileInput');
const grid=document.getElementById('grid');
const opacity=document.getElementById('opacity');
const scale=document.getElementById('scale');
const clearBtn=document.getElementById('clearBtn');
const zipBtn=document.getElementById('zipBtn');
let processed=[];

fileInput.addEventListener('change',()=>handleFiles(fileInput.files));
clearBtn.onclick=()=>{grid.innerHTML='';processed=[];fileInput.value='';};
zipBtn.onclick=async()=>{
  if(!processed.length) return alert('–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π');
  const zip=new JSZip();
  for(const p of processed){zip.file(p.name,await p.blob.arrayBuffer());}
  const content=await zip.generateAsync({type:'blob'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(content);a.download='images.zip';a.click();
};

function handleFiles(list){
  [...list].forEach(f=>{
    if(f.type.startsWith('image/')){
      const r=new FileReader();
      r.onload=e=>{
        const img=new Image();
        img.onload=async()=>{const {blob,url}=await watermark(img);addThumb(f.name,blob,url);};
        img.src=e.target.result;
      };
      r.readAsDataURL(f);
    }
  });
}

async function watermark(img){
  const maxSide=2000; // –æ–≥—Ä–∞–Ω–∏—á–∏–º –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
  let w=img.naturalWidth,h=img.naturalHeight;
  if(Math.max(w,h)>maxSide){
    const ratio=maxSide/Math.max(w,h);w=Math.round(w*ratio);h=Math.round(h*ratio);
  }
  const c=document.createElement('canvas');c.width=w;c.height=h;
  const ctx=c.getContext('2d');ctx.drawImage(img,0,0,w,h);
  ctx.fillStyle=`rgba(20,20,20,${opacity.value})`;
  ctx.font=`${Math.round(Math.min(w,h)*(scale.value/100))}px sans-serif`;
  ctx.rotate(-Math.PI/6);
  for(let x=-w;x<w*2;x+=200){
    for(let y=-h;y<h*2;y+=150){
      ctx.fillText('–≤—ã–∑–æ–≤–¥—Ç–ø.—Ä—Ñ',x,y);
    }
  }
  ctx.rotate(Math.PI/6);
  const blob=await new Promise(r=>c.toBlob(r,'image/png',0.9));
  return{blob,url:URL.createObjectURL(blob)};
}

function addThumb(name,blob,url){
  const div=document.createElement('div');div.className='thumb';
  div.innerHTML=`<img src="${url}"><div class="actions">
  <a href="${url}" download="${name.replace(/\.[^.]+$/,'')}.png" class="btn primary">–°–∫–∞—á–∞—Ç—å</a>
  </div>`;
  grid.appendChild(div);
  processed.push({name:name.replace(/\.[^.]+$/,'.png'),blob});
}
</script>
</body>
</html>
