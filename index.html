<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ú–∏–Ω–∏-CRM ‚Äî –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage)</title>
<style>
  :root{
    --bg:#0f1724;
    --card-bg: rgba(255,255,255,0.06);
    --accent: linear-gradient(135deg,#6EE7B7 0%, #3B82F6 100%);
    --glass-border: rgba(255,255,255,0.12);
    --muted: rgba(255,255,255,0.65);
    --cta-color: #0b84ff;
    --danger: #ff5c6c;
    --max-width: 980px;
    --radius: 14px;
  }
  html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto,"Helvetica Neue", Arial; background: radial-gradient(1200px 600px at 10% 10%, rgba(59,130,246,0.08), transparent), radial-gradient(1000px 500px at 90% 90%, rgba(110,231,183,0.04), transparent), var(--bg); color: #fff; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
  .wrap{max-width:var(--max-width);margin:28px auto;padding:20px;display:grid;grid-template-columns: 360px 1fr;gap:20px;align-items:start;}
  header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  h1{font-size:20px;margin:0}
  p.lead{margin:0;color:var(--muted);font-size:13px}
  /* glass panel */
  .panel{
    background: var(--card-bg);
    border-radius:var(--radius);
    padding:16px;
    border:1px solid var(--glass-border);
    box-shadow: 0 6px 30px rgba(2,6,23,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
    backdrop-filter: blur(8px) saturate(120%);
    -webkit-backdrop-filter: blur(8px) saturate(120%);
  }
  /* left column ‚Äî form */
  .form .row{display:flex;gap:10px;margin-bottom:10px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="text"], input[type="tel"], input[type="number"]{
    width:100%;
    padding:10px 12px;
    border-radius:10px;border:1px solid rgba(255,255,255,0.06);
    background: rgba(255,255,255,0.03); color: #fff; outline:none;
    font-size:14px;
  }
  input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  .btn{
    display:inline-flex;align-items:center;gap:8px;
    padding:10px 14px;border-radius:14px;border:none;cursor:pointer;
    font-weight:600;font-size:14px;
    box-shadow: 0 6px 18px rgba(11,132,255,0.18);
    transition: transform .12s ease, box-shadow .12s ease;
  }
  .btn:active{transform:translateY(1px)}
  .btn-cta{
    background: var(--accent);
    color:#042029;
    padding:12px 16px;
    border-radius:18px;
  }
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px 12px;border-radius:12px}
  .small{font-size:13px;padding:8px 10px;border-radius:10px}
  /* right column ‚Äî list */
  .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:12px}
  .search{flex:1;display:flex;gap:8px}
  .search input{flex:1}
  .clients-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
  .card{
    padding:12px;border-radius:14px;border:1px solid var(--glass-border);
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    box-shadow: 0 6px 20px rgba(2,6,23,0.5);
    display:flex;flex-direction:column;gap:8px;
  }
  .card .top{display:flex;justify-content:space-between;align-items:center}
  .client-name{font-weight:700;font-size:16px}
  .meta{font-size:12px;color:var(--muted)}
  .gov{font-weight:600;padding:6px 8px;border-radius:10px;background:rgba(255,255,255,0.02);font-size:12px}
  .row-between{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .muted{color:var(--muted);font-size:13px}
  .money{font-weight:700}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn-icon{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;min-width:40px}
  .whatsapp{
    background: linear-gradient(135deg,#25D366,#128C7E); color:#042029; border-radius:12px; padding:8px 12px; font-weight:700; display:inline-flex;align-items:center;gap:8px;
    text-decoration:none;
  }
  footer{grid-column:1/-1;margin-top:12px;color:var(--muted);font-size:13px;display:flex;justify-content:space-between;align-items:center;gap:12px}
  .controls{display:flex;gap:8px;align-items:center}
  .percent-control{display:flex;gap:10px;align-items:center}
  input[type=range]{width:160px}
  /* responsive */
  @media (max-width:900px){ .wrap{grid-template-columns:1fr; padding:14px} .clients-list{grid-template-columns:repeat(auto-fill,minmax(180px,1fr))} }
  @media (max-width:600px){
    body{padding-bottom:40px}
    .panel{padding:12px;border-radius:12px}
    .btn{font-size:14px}
    .wrap{margin:12px auto;padding:12px}
    header{flex-direction:column;align-items:flex-start;gap:8px}
    .clients-list{grid-template-columns:1fr}
    .whatsapp{padding:10px 14px;border-radius:16px}
  }
  /* tiny helpers */
  .note{font-size:12px;color:var(--muted)}
  .flex{display:flex;gap:8px;align-items:center}
  .center{display:flex;justify-content:center;align-items:center}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>–ú–∏–Ω–∏-CRM (–±—Ä–∞—É–∑–µ—Ä, localStorage)</h1>
        <p class="lead">–ö–ª–∏–µ–Ω—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ —É —Ç–µ–±—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –°—Ç–µ–∫–ª—è–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω, –º–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è, WhatsApp-–∫–Ω–æ–ø–∫–∞ –∏ –∞–≤—Ç–æ–º–∞—Ç —Ä–∞—Å—á—ë—Ç–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã.</p>
      </div>
      <div class="flex">
        <div class="percent-control panel" style="display:flex;align-items:center;gap:10px;">
          <label style="margin:0;font-size:12px;color:var(--muted)">–ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã</label>
          <input id="globalPercentRange" type="range" min="0" max="100" value="10" />
          <input id="globalPercent" type="number" min="0" max="100" value="10" style="width:64px" />
        </div>
      </div>
    </header>

    <!-- left: —Ñ–æ—Ä–º–∞ -->
    <aside class="panel form">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <strong>–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</strong>
          <div class="note">–í–≤–æ–¥–∏ —Ç–µ–ª–µ—Ñ–æ–Ω —Å –∫–æ–¥–æ–º —Å—Ç—Ä–∞–Ω—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã WhatsApp (–ø—Ä–∏–º–µ—Ä: +79161234567)</div>
        </div>
        <div class="note">Local only</div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>–ò–º—è</label>
          <input id="inputName" type="text" placeholder="–ú–∞—Ä–∫" />
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>–ì–æ—Å. –Ω–æ–º–µ—Ä</label>
          <input id="inputPlate" type="text" placeholder="A123BC77" />
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input id="inputPhone" type="tel" placeholder="+79161234567" />
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>–°—É–º–º–∞ (‚ÇΩ)</label>
          <input id="inputAmount" type="number" step="0.01" placeholder="10000" />
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="addBtn" class="btn btn-cta">–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="margin-left:6px"><path d="M5 12h14" stroke="#042029" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 5v14" stroke="#042029" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <button id="clearAll" class="btn btn-ghost small">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
        <button id="importBtn" class="btn btn-ghost small">–ò–º–ø–æ—Ä—Ç</button>
        <button id="exportBtn" class="btn small">–≠–∫—Å–ø–æ—Ä—Ç</button>
      </div>

      <div style="margin-top:12px">
        <label>–ë—ã—Å—Ç—Ä–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞</label>
        <div class="note">–¢–µ–ª–µ—Ñ–æ–Ω –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –¥–ª—è WhatsApp: –≤—Å–µ —Å–∏–º–≤–æ–ª—ã, –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä, —É–±–∏—Ä–∞—é—Ç—Å—è. WhatsApp —Ç—Ä–µ–±—É–µ—Ç –∫–æ–¥ —Å—Ç—Ä–∞–Ω—ã –±–µ–∑ + (–Ω–∞–ø—Ä–∏–º–µ—Ä 7916...)</div>
      </div>
    </aside>

    <!-- right: —Å–ø–∏—Å–æ–∫ -->
    <main>
      <div class="panel">
        <div class="toolbar">
          <div class="search">
            <input id="search" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, –Ω–æ–º–µ—Ä—É, —Ç–µ–ª–µ—Ñ–æ–Ω—É..." />
            <button id="resetSearch" class="btn btn-ghost small">–°–±—Ä–æ—Å</button>
          </div>
          <div class="controls">
            <div class="note">–í—Å–µ–≥–æ: <span id="totalCount">0</span></div>
            <div class="note">–û–±—â–∞—è —Å—É–º–º–∞: <strong id="sumTotal">0 ‚ÇΩ</strong></div>
            <div class="note">–ö –≤—ã–ø–ª–∞—Ç–µ: <strong id="sumToPay">0 ‚ÇΩ</strong></div>
          </div>
        </div>

        <div id="clients" class="clients-list"></div>
      </div>

      <footer>
        <div class="note">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: <strong>localStorage</strong> ‚Äî –¥–∞–Ω–Ω—ã–µ –≤–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.</div>
        <div class="note">–°–¥–µ–ª–∞–Ω–æ –∫—Ä–∞—Å–∏–≤–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –Ω–∞ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–µ (‚â§600px) –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞.</div>
      </footer>
    </main>
  </div>

<script>
(function(){
  const LS_KEY = 'miniCRM_clients_v1';
  const LS_PERCENT = 'miniCRM_percent_v1';

  // DOM
  const inputName = document.getElementById('inputName');
  const inputPlate = document.getElementById('inputPlate');
  const inputPhone = document.getElementById('inputPhone');
  const inputAmount = document.getElementById('inputAmount');
  const addBtn = document.getElementById('addBtn');
  const clientsWrap = document.getElementById('clients');
  const totalCount = document.getElementById('totalCount');
  const sumTotal = document.getElementById('sumTotal');
  const sumToPay = document.getElementById('sumToPay');
  const searchInput = document.getElementById('search');
  const resetSearch = document.getElementById('resetSearch');
  const clearAll = document.getElementById('clearAll');
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const globalPercentRange = document.getElementById('globalPercentRange');
  const globalPercentInput = document.getElementById('globalPercent');

  // data
  let clients = [];
  let percent = 10;

  // helpers
  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      clients = raw ? JSON.parse(raw) : [];
    }catch(e){ clients = []; }
    try{
      const p = localStorage.getItem(LS_PERCENT);
      if(p !== null) percent = Number(p);
    }catch(e){}
    globalPercentRange.value = percent;
    globalPercentInput.value = percent;
  }

  function save(){
    localStorage.setItem(LS_KEY, JSON.stringify(clients));
    localStorage.setItem(LS_PERCENT, String(percent));
  }

  function fmtMoney(n){
    if(!isFinite(n)) return '0 ‚ÇΩ';
    return Number(n).toLocaleString('ru-RU', {maximumFractionDigits:2}) + ' ‚ÇΩ';
  }

  function calcSalary(amount){
    const a = Number(amount) || 0;
    return (a * (Number(percent)||0) / 100);
  }

  function digitsOnlyPhone(phone){
    if(!phone) return '';
    const only = phone.replace(/\\D+/g,'');
    // If phone starts with 8 and length looks like RU (11 digits), convert 8->7 (common), but we won't assume.
    return only;
  }

  function buildWhatsAppLink(phone){
    const digits = digitsOnlyPhone(phone);
    if(!digits) return null;
    return 'https://wa.me/' + digits;
  }

  function uid(){ return 'id_' + Math.random().toString(36).slice(2,9); }

  // render
  function render(filterText=''){
    clientsWrap.innerHTML = '';
    const f = filterText.trim().toLowerCase();
    const visible = clients.filter(c => {
      if(!f) return true;
      return (c.name || '').toLowerCase().includes(f) ||
             (c.plate || '').toLowerCase().includes(f) ||
             (c.phone || '').toLowerCase().includes(f) ||
             String(c.amount || '').toLowerCase().includes(f);
    });

    let total = 0, totalPay = 0;
    visible.forEach(c => {
      total += Number(c.amount || 0);
      totalPay += calcSalary(c.amount);
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="top">
          <div>
            <div class="client-name">${escapeHtml(c.name || '‚Äî')}</div>
            <div class="meta">${escapeHtml(c.phone || '')}</div>
          </div>
          <div style="text-align:right">
            <div class="gov">${escapeHtml(c.plate || '')}</div>
            <div class="muted" style="font-size:12px;margin-top:6px">ID: ${c.id}</div>
          </div>
        </div>

        <div class="row-between">
          <div>
            <div class="muted">–°—É–º–º–∞</div>
            <div class="money">${fmtMoney(c.amount)}</div>
          </div>
          <div>
            <div class="muted">–ö –≤—ã–ø–ª–∞—Ç–µ (${percent}%)</div>
            <div class="money">${fmtMoney(calcSalary(c.amount))}</div>
          </div>
        </div>

        <div class="actions">
          <a class="whatsapp" target="_blank" rel="noopener" href="${buildWhatsAppLink(c.phone) || '#'}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right:6px">
              <path d="M21 12.08A9 9 0 1 0 12.08 21l-1.1.29.29-1.1A9 9 0 0 0 21 12.08z" stroke="#042029" stroke-width="0" fill="#fff"/>
            </svg>
            WhatsApp
          </a>

          <button class="btn-icon" data-action="edit" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
          <button class="btn-icon" data-action="copy" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä">üìã</button>
          <button class="btn-icon" data-action="delete" title="–£–¥–∞–ª–∏—Ç—å" style="color:var(--danger)">üóëÔ∏è</button>
        </div>
      `;
      // attach actions handlers
      card.querySelectorAll('[data-action]').forEach(btn=>{
        btn.addEventListener('click', ()=> {
          const action = btn.getAttribute('data-action');
          if(action === 'edit') editClient(c.id);
          if(action === 'delete') removeClient(c.id);
          if(action === 'copy') { navigator.clipboard?.writeText(c.phone || '') .then(()=> alert('–ù–æ–º–µ—Ä —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä')) .catch(()=> alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å')) }
        });
      });

      clientsWrap.appendChild(card);
    });

    totalCount.textContent = visible.length;
    sumTotal.textContent = fmtMoney(total);
    sumToPay.textContent = fmtMoney(totalPay);
  }

  // escape
  function escapeHtml(s){
    if(!s) return '';
    return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]});
  }

  // actions
  function addClient(){
    const name = inputName.value.trim();
    const plate = inputPlate.value.trim();
    const phone = inputPhone.value.trim();
    const amount = Number(inputAmount.value) || 0;
    if(!name){
      alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞');
      return;
    }
    const c = { id: uid(), name, plate, phone, amount };
    clients.unshift(c);
    save();
    render(searchInput.value);
    // clear some fields for convenience
    inputName.value = '';
    inputPlate.value = '';
    inputPhone.value = '';
    inputAmount.value = '';
    inputName.focus();
  }

  function editClient(id){
    const c = clients.find(x=>x.id===id);
    if(!c) return;
    const newName = prompt('–ò–º—è', c.name);
    if(newName === null) return;
    const newPlate = prompt('–ì–æ—Å. –Ω–æ–º–µ—Ä', c.plate);
    if(newPlate === null) return;
    const newPhone = prompt('–¢–µ–ª–µ—Ñ–æ–Ω', c.phone);
    if(newPhone === null) return;
    const newAmount = prompt('–°—É–º–º–∞', String(c.amount || 0));
    if(newAmount === null) return;
    c.name = newName.trim();
    c.plate = newPlate.trim();
    c.phone = newPhone.trim();
    c.amount = Number(newAmount) || 0;
    save(); render(searchInput.value);
  }

  function removeClient(id){
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞?')) return;
    clients = clients.filter(x=>x.id!==id);
    save(); render(searchInput.value);
  }

  function clearEverything(){
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) return;
    clients = [];
    percent = 10;
    save();
    render();
    globalPercentRange.value = percent;
    globalPercentInput.value = percent;
  }

  function exportData(){
    const payload = { clients, percent, exportedAt: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'miniCRM_export.json';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  function importData(){
    const input = document.createElement('input');
    input.type = 'file'; input.accept = 'application/json';
    input.addEventListener('change', () => {
      const f = input.files?.[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = e => {
        try{
          const obj = JSON.parse(String(e.target.result));
          if(Array.isArray(obj.clients)) clients = obj.clients;
          if(typeof obj.percent === 'number') percent = obj.percent;
          save(); render(); globalPercentRange.value = percent; globalPercentInput.value = percent;
          alert('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω');
        }catch(err){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç'); }
      };
      reader.readAsText(f);
    });
    input.click();
  }

  // events
  addBtn.addEventListener('click', addClient);
  inputAmount.addEventListener('keydown', (e)=>{ if(e.key==='Enter') addClient(); });
  searchInput.addEventListener('input', ()=> render(searchInput.value));
  resetSearch.addEventListener('click', ()=>{ searchInput.value=''; render(); });
  clearAll.addEventListener('click', clearEverything);
  exportBtn.addEventListener('click', exportData);
  importBtn.addEventListener('click', importData);

  globalPercentRange.addEventListener('input', (e)=> {
    percent = Number(e.target.value);
    globalPercentInput.value = percent;
    save(); render(searchInput.value);
  });
  globalPercentInput.addEventListener('change', (e)=> {
    let val = Number(e.target.value);
    if(isNaN(val) || val < 0) val = 0;
    if(val > 100) val = 100;
    percent = val;
    globalPercentRange.value = percent;
    save(); render(searchInput.value);
  });

  // initial load
  load();
  // seed example if empty (optional)
  if(!clients.length){
    clients = [
      { id: uid(), name: '–ú–∞—Ä–∫ –ò–≤–∞–Ω–æ–≤', plate: 'A123BC77', phone:'+79161234567', amount: 25000 },
      { id: uid(), name: '–ï–ª–µ–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞', plate: 'B987YT99', phone:'+79261239900', amount: 15000 }
    ];
    save();
  }
  render();

  // expose for dev (optional)
  window._miniCRM = { get clients(){return clients}, save, load };

})();
</script>
</body>
</html>
