<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ú–∏–Ω–∏-CRM</title>
<style>
  :root{
    --bg:#0e141f;
    --card-bg: rgba(255,255,255,0.05);
    --glass-border: rgba(255,255,255,0.12);
    --accent: linear-gradient(135deg,#4facfe 0%, #00f2fe 100%);
    --cta:#0b84ff;
    --danger:#ff5c6c;
    --radius:16px;
  }
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:#fff;-webkit-font-smoothing:antialiased;}
  .wrap{max-width:960px;margin:0 auto;padding:20px;display:grid;grid-template-columns:360px 1fr;gap:20px}
  header{grid-column:1/-1;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
  h1{margin:0;font-size:20px;font-weight:700}
  .panel{background:var(--card-bg);border:1px solid var(--glass-border);border-radius:var(--radius);backdrop-filter:blur(8px) saturate(120%);padding:16px;box-shadow:0 8px 30px rgba(0,0,0,0.6);}
  label{font-size:12px;display:block;margin-bottom:4px;color:rgba(255,255,255,0.7)}
  input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.04);color:#fff;font-size:14px}
  input:focus{outline:none;border-color:rgba(255,255,255,0.3)}
  .btn{cursor:pointer;border:none;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:12px 16px;border-radius:18px;transition:.15s}
  .btn:active{transform:translateY(1px)}
  .btn-cta{background:var(--accent);color:#042029;font-weight:700}
  .btn-ghost{background:rgba(255,255,255,0.06);color:#fff}
  .btn-danger{background:var(--danger);color:#fff}
  .percent-switch{display:flex;gap:8px;margin-bottom:14px}
  .percent-switch button{flex:1}
  .clients-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.04),rgba(255,255,255,0.02));border:1px solid var(--glass-border);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px;box-shadow:0 6px 20px rgba(0,0,0,0.4)}
  .client-name{font-weight:700;font-size:16px}
  .gov{font-weight:600;background:rgba(255,255,255,0.08);padding:4px 8px;border-radius:10px;font-size:12px}
  .row-between{display:flex;justify-content:space-between}
  .money{font-weight:700}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .whatsapp{background:linear-gradient(135deg,#25D366,#128C7E);color:#042029;font-weight:700;border-radius:12px;padding:8px 12px;text-decoration:none}
  footer{grid-column:1/-1;margin-top:10px;display:flex;justify-content:space-between;align-items:center;font-size:13px;color:rgba(255,255,255,0.6)}
  @media(max-width:800px){.wrap{grid-template-columns:1fr}}
  @media(max-width:600px){.wrap{padding:12px}.clients-list{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>–ú–∏–Ω–∏-CRM</h1>
    <div>
      <button id="exportBtn" class="btn btn-ghost">–≠–∫—Å–ø–æ—Ä—Ç</button>
    </div>
  </header>

  <!-- —Ñ–æ—Ä–º–∞ -->
  <aside class="panel">
    <div class="percent-switch">
      <button class="btn btn-ghost" data-percent="15">15%</button>
      <button class="btn btn-ghost" data-percent="25">25%</button>
      <button class="btn btn-ghost" data-percent="30">30%</button>
    </div>
    <label>–ò–º—è</label>
    <input id="inputName" type="text" placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞" />
    <label style="margin-top:10px">–ì–æ—Å. –Ω–æ–º–µ—Ä</label>
    <input id="inputPlate" type="text" placeholder="A123BC77" />
    <label style="margin-top:10px">–¢–µ–ª–µ—Ñ–æ–Ω</label>
    <input id="inputPhone" type="tel" placeholder="+79161234567" />
    <label style="margin-top:10px">–°—É–º–º–∞ (‚ÇΩ)</label>
    <input id="inputAmount" type="number" placeholder="10000" />
    <div style="margin-top:14px;display:flex;gap:8px">
      <button id="addBtn" class="btn btn-cta">–î–æ–±–∞–≤–∏—Ç—å</button>
      <button id="clearAll" class="btn btn-danger">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
    </div>
  </aside>

  <!-- —Å–ø–∏—Å–æ–∫ -->
  <main>
    <div class="panel">
      <div style="margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
        <input id="search" type="text" placeholder="–ü–æ–∏—Å–∫..." style="flex:1;min-width:140px">
        <div style="font-size:14px">
          –í—Å–µ–≥–æ: <span id="totalCount">0</span> ‚Ä¢ –û–±—â–∞—è —Å—É–º–º–∞: <span id="sumTotal">0 ‚ÇΩ</span> ‚Ä¢ –ö –≤—ã–ø–ª–∞—Ç–µ: <span id="sumToPay">0 ‚ÇΩ</span>
        </div>
      </div>
      <div id="clients" class="clients-list"></div>
    </div>
    <footer>
      <div>–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ç–≤–æ—ë–º –±—Ä–∞—É–∑–µ—Ä–µ</div>
    </footer>
  </main>
</div>

<script>
(function(){
  const LS_KEY = 'miniCRM_clients_v2';
  const LS_PERCENT = 'miniCRM_percent_v2';
  let clients = [];
  let percent = 15;

  const inputName=document.getElementById('inputName');
  const inputPlate=document.getElementById('inputPlate');
  const inputPhone=document.getElementById('inputPhone');
  const inputAmount=document.getElementById('inputAmount');
  const addBtn=document.getElementById('addBtn');
  const clientsWrap=document.getElementById('clients');
  const totalCount=document.getElementById('totalCount');
  const sumTotal=document.getElementById('sumTotal');
  const sumToPay=document.getElementById('sumToPay');
  const searchInput=document.getElementById('search');
  const clearAll=document.getElementById('clearAll');
  const exportBtn=document.getElementById('exportBtn');

  // helpers
  function load(){
    try{clients=JSON.parse(localStorage.getItem(LS_KEY))||[]}catch(e){clients=[]}
    try{percent=Number(localStorage.getItem(LS_PERCENT))||15}catch(e){percent=15}
    updatePercentButtons();
  }
  function save(){localStorage.setItem(LS_KEY,JSON.stringify(clients));localStorage.setItem(LS_PERCENT,percent)}
  function fmtMoney(n){return Number(n||0).toLocaleString('ru-RU')+' ‚ÇΩ'}
  function calcSalary(a){return (Number(a)||0)*percent/100}
  function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
  function uid(){return 'id_'+Math.random().toString(36).slice(2,9)}
  function digitsOnly(p){return (p||'').replace(/\\D+/g,'')}
  function waLink(p){const d=digitsOnly(p);return d?'https://wa.me/'+d:null}

  // render
  function render(filt=''){
    clientsWrap.innerHTML='';
    const f=filt.trim().toLowerCase();
    let total=0, totalPay=0;
    clients.filter(c=>!f||c.name.toLowerCase().includes(f)||c.plate.toLowerCase().includes(f)||c.phone.includes(f))
    .forEach(c=>{
      total+=Number(c.amount||0);
      totalPay+=calcSalary(c.amount);
      const card=document.createElement('div');
      card.className='card';
      card.innerHTML=`
        <div class="row-between">
          <div>
            <div class="client-name">${escapeHtml(c.name)}</div>
            <div style="font-size:12px;opacity:.7">${escapeHtml(c.phone)}</div>
          </div>
          <div class="gov">${escapeHtml(c.plate)}</div>
        </div>
        <div class="row-between">
          <div>–°—É–º–º–∞<br><span class="money">${fmtMoney(c.amount)}</span></div>
          <div>–ö –≤—ã–ø–ª–∞—Ç–µ (${percent}%)<br><span class="money">${fmtMoney(calcSalary(c.amount))}</span></div>
        </div>
        <div class="actions">
          <a class="whatsapp" target="_blank" href="${waLink(c.phone)||'#'}">WhatsApp</a>
          <button data-act="edit" class="btn btn-ghost">‚úèÔ∏è</button>
          <button data-act="del" class="btn btn-ghost">üóëÔ∏è</button>
        </div>
      `;
      card.querySelector('[data-act="edit"]').onclick=()=>editClient(c.id);
      card.querySelector('[data-act="del"]').onclick=()=>removeClient(c.id);
      clientsWrap.appendChild(card);
    });
    totalCount.textContent=clients.length;
    sumTotal.textContent=fmtMoney(total);
    sumToPay.textContent=fmtMoney(totalPay);
  }

  // actions
  function addClient(){
    if(!inputName.value.trim()){alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');return}
    clients.unshift({id:uid(),name:inputName.value.trim(),plate:inputPlate.value.trim(),phone:inputPhone.value.trim(),amount:Number(inputAmount.value)||0});
    inputName.value=inputPlate.value=inputPhone.value=inputAmount.value='';
    save();render(searchInput.value);
  }
  function editClient(id){
    const c=clients.find(x=>x.id===id);if(!c)return;
    const n=prompt('–ò–º—è',c.name);if(n===null)return;
    const p=prompt('–ì–æ—Å. –Ω–æ–º–µ—Ä',c.plate);if(p===null)return;
    const ph=prompt('–¢–µ–ª–µ—Ñ–æ–Ω',c.phone);if(ph===null)return;
    const a=prompt('–°—É–º–º–∞',c.amount);if(a===null)return;
    c.name=n;c.plate=p;c.phone=ph;c.amount=Number(a)||0;
    save();render(searchInput.value);
  }
  function removeClient(id){if(confirm('–£–¥–∞–ª–∏—Ç—å?')){clients=clients.filter(c=>c.id!==id);save();render(searchInput.value)}}
  function clearAllFn(){if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ—Ö?')){clients=[];save();render()}}
  function exportData(){
    const payload={percent,clients,exportedAt:new Date().toISOString()};
    const json=JSON.stringify(payload,null,2);
    const blob=new Blob([json],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download='crm_export.json';a.click();
    URL.revokeObjectURL(url);
    // –ø–ª—é—Å –ø–æ–∫–∞–∑–∞—Ç—å –≤ –æ–∫–Ω–µ
    const w=window.open('about:blank','exportWin');w.document.write('<pre>'+escapeHtml(json)+'</pre>');
  }

  // percent buttons
  function updatePercentButtons(){
    document.querySelectorAll('.percent-switch button').forEach(b=>{
      b.style.background=(Number(b.dataset.percent)===percent)?'var(--accent)':'rgba(255,255,255,0.06)';
      b.style.color=(Number(b.dataset.percent)===percent)?'#042029':'#fff';
    });
  }
  document.querySelectorAll('.percent-switch button').forEach(b=>{
    b.onclick=()=>{percent=Number(b.dataset.percent);save();updatePercentButtons();render(searchInput.value)};
  });

  // events
  addBtn.onclick=addClient;
  clearAll.onclick=clearAllFn;
  searchInput.oninput=()=>render(searchInput.value);
  exportBtn.onclick=exportData;

  // init
  load();
  render();
})();
</script>
</body>
</html>
