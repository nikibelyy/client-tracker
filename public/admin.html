<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —á–∞—Ç–∞</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-light">

<div class="container mt-4">
  <h1 class="mb-4">üí¨ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>

  <!-- Login -->
  <div id="loginCard" class="card p-4 shadow">
    <h5>–í—Ö–æ–¥</h5>
    <input type="password" id="pass" class="form-control mb-3" placeholder="–ü–∞—Ä–æ–ª—å">
    <button class="btn btn-primary w-100" id="btnLogin">–í–æ–π—Ç–∏</button>
    <div class="text-danger mt-2" id="loginMsg"></div>
  </div>

  <!-- Panel -->
  <div id="panel" style="display:none;">
    <div class="d-flex justify-content-between mt-4 mb-3">
      <h4>–°–µ—Å—Å–∏–∏</h4>
      <button class="btn btn-success" id="btnNew">–°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
    </div>
    <div id="sessions" class="list-group mb-4"></div>

    <div id="chatWrap" style="display:none;">
      <h4 class="mb-2">–ê–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç</h4>
      <div id="chat" class="border p-3 mb-2 bg-white" style="height:300px; overflow:auto;"></div>
      <div class="input-group">
        <input id="msg" class="form-control" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
        <button class="btn btn-primary" id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<script>
const socket = io();
let currentSid = null;

async function api(path, method='GET', body) {
  const opt = { method, headers: {} };
  if (body) { opt.headers['Content-Type']='application/json'; opt.body = JSON.stringify(body); }
  const r = await fetch(path, opt);
  return r.json();
}

document.getElementById('btnLogin').onclick = async () => {
  const pass = document.getElementById('pass').value;
  const r = await api('/api/login','POST',{password:pass});
  if (r.ok) {
    document.getElementById('loginCard').style.display='none';
    document.getElementById('panel').style.display='';
    loadSessions();
  } else {
    document.getElementById('loginMsg').innerText = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
  }
};

document.getElementById('btnNew').onclick = async () => {
  const r = await api('/api/session','POST',{});
  alert('–°—Å—ã–ª–∫–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:\n' + r.link);
  loadSessions();
};

async function loadSessions(){
  const list = await api('/api/sessions');
  const wrap = document.getElementById('sessions');
  wrap.innerHTML='';
  list.forEach(s=>{
    const el = document.createElement('div');
    el.className='list-group-item d-flex justify-content-between align-items-center';
    el.innerHTML=`
      <div>
        <div><b>ID:</b> ${s.id}</div>
        <small>–ö–ª–∏–µ–Ω—Ç: ${s.clientConnected ? 'üü¢ online':'üî¥ offline'} | –ê–¥–º–∏–Ω: ${s.adminConnected?'üü¢':'üî¥'}</small>
      </div>
      <button class="btn btn-outline-primary btn-sm" data-sid="${s.id}">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</button>
    `;
    el.querySelector('button').onclick=()=>openChat(s.id);
    wrap.appendChild(el);
  });
}

function openChat(sid){
  currentSid=sid;
  document.getElementById('chatWrap').style.display='';
  document.getElementById('chat').innerHTML='';
  socket.emit('join',{role:'admin',sid});
}

socket.on('history', msgs=>{
  const chat=document.getElementById('chat');
  chat.innerHTML='';
  msgs.forEach(appendMsg);
});

socket.on('message', m=>appendMsg(m));
socket.on('system', s=>appendSys(s.msg));

document.getElementById('send').onclick=()=>{
  const text=document.getElementById('msg').value;
  if (!text) return;
  socket.emit('message',{text});
  document.getElementById('msg').value='';
};

function appendMsg(m){
  const chat=document.getElementById('chat');
  const el=document.createElement('div');
  el.innerHTML=`<b>${m.from}</b>: ${escapeHtml(m.text)} <small class="text-muted">${new Date(m.ts).toLocaleTimeString()}</small>`;
  chat.appendChild(el);
  chat.scrollTop=chat.scrollHeight;
}
function appendSys(txt){
  const chat=document.getElementById('chat');
  const el=document.createElement('div');
  el.className='text-secondary fst-italic';
  el.innerText=txt;
  chat.appendChild(el);
  chat.scrollTop=chat.scrollHeight;
}
function escapeHtml(s){return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
</script>
</body>
</html>
