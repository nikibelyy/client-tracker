<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–ß–∞—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-light">

<div class="container mt-4">
  <h2 class="mb-3">üí¨ –û–Ω–ª–∞–π–Ω-—á–∞—Ç</h2>
  <div id="status" class="mb-2 text-muted">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
  <div id="chat" class="border p-3 bg-white mb-2" style="height:300px; overflow:auto;"></div>
  <div class="input-group">
    <input id="msg" class="form-control" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
    <button class="btn btn-primary" id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
</div>

<script>
const sid=new URLSearchParams(window.location.search).get('sid');
const socket=io();
socket.emit('join',{role:'client',sid});

socket.on('connect',()=>document.getElementById('status').innerText='‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ');
socket.on('history',msgs=>{const c=document.getElementById('chat');c.innerHTML='';msgs.forEach(appendMsg)});
socket.on('message',m=>appendMsg(m));
socket.on('system',s=>appendSys(s.msg));

document.getElementById('send').onclick=()=>{
  const t=document.getElementById('msg').value;
  if(!t)return;
  socket.emit('message',{text:t});
  document.getElementById('msg').value='';
};

function appendMsg(m){
  const c=document.getElementById('chat');
  const el=document.createElement('div');
  el.innerHTML=`<b>${m.from}</b>: ${escapeHtml(m.text)} <small class="text-muted">${new Date(m.ts).toLocaleTimeString()}</small>`;
  c.appendChild(el);
  c.scrollTop=c.scrollHeight;
}
function appendSys(txt){
  const c=document.getElementById('chat');
  const el=document.createElement('div');
  el.className='text-secondary fst-italic';
  el.innerText=txt;
  c.appendChild(el);
  c.scrollTop=c.scrollHeight;
}
function escapeHtml(s){return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
</script>
</body>
</html>
